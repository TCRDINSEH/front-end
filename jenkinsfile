pipeline {
    agent any

    environment {
        PROJECT_ID = 'fundamental-run-464208-v1'
        CLUSTER_NAME = 'tf-gke-cluster'
        CLUSTER_ZONE = 'us-central1-a'
        IMAGE_NAME = 'frontend'
        ARTIFACT_REGISTRY = "us-central1-docker.pkg.dev/${PROJECT_ID}/frontend-repo"
        DEPLOYMENT_FILE = 'k8s-deployment.yaml' // Make sure this exists in repo
        GCP_CREDENTIALS = 'gcp-service-account' // Jenkins Secret File credential
    }

    stages {
        stage('Checkout Code') {
            steps {
             sh '''
          rm -rf front-end
          git clone https://github.com/TCRDINSEH/front-end.git
          cd front-end
          pwd
          chmod 777 *
          ls -la
        '''
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh 'docker build . -t "${IMAGE_NAME}:latest"'

                }
            }
        }

        stage('Tag and Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("https://${ARTIFACT_REGISTRY}", 'artifact-registry-credentials') {
                        sh """
                            docker tag ${IMAGE_NAME}:latest ${ARTIFACT_REGISTRY}/${IMAGE_NAME}:latest
                            docker push ${ARTIFACT_REGISTRY}/${IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }

        stage('Deploy to GKE') {
            steps {
                withCredentials([file(credentialsId: "${GCP_CREDENTIALS}", variable: 'GCLOUD_KEY')]) {
                    sh """
                        gcloud auth activate-service-account --key-file=$GCLOUD_KEY
                        gcloud config set project ${PROJECT_ID}
                        gcloud container clusters get-credentials ${CLUSTER_NAME} --zone ${CLUSTER_ZONE} --project ${PROJECT_ID}
                        kubectl apply -f ${DEPLOYMENT_FILE}
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment succeeded!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
}
